@using Modelos_AutomaG
@using API_Consumer

@{
    var aspirantesLayout = CRUD<Aspirantes>.GetAll();

    var notificacionesLayout = aspirantesLayout
        .OrderByDescending(a => a.fecharegistro)
        .Take(5)
        .ToList();

    var notificacionesHoyLayout = aspirantesLayout
        .Count(a => a.fecharegistro.Date == DateTime.Today);
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Sistema de Maestrías</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
                body {
                        margin: 0;
                        background-color: #F3F4F6;
                        font-family: 'Inter', sans-serif;
                        overflow-x: hidden;

        }

                .dashboard-wrapper {
                        display: flex;
                        min-height: 100vh;

        }

        /* ===== NOTIFICACIONES ===== */
        .notificacion-texto {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 100%;
        }



        /* ========== SIDEBAR ========== */
                .sidebar {
                        width: 260px;
                        background: #fff;
                        border-right: 1px solid #E5E7EB;
                        padding: 1.5rem;
                        position: fixed;
                        height: 100vh;
                        z-index: 100;
                        transition: transform .3s ease;

        }

                    .sidebar.hidden {
                            transform: translateX(-100%);

        }

                .sidebar-header {
                        display: flex;
                        gap: 12px;
                        margin-bottom: 2rem;

        }

                .logo-box {
                        width: 42px;
                        height: 42px;
                        background: #D91016;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;

        }

                .logo-text h5 {
                        margin: 0;
                        font-weight: 700;
                        font-size: 0.9rem;
                        line-height: 1.2;

        }

                .logo-text small {
                        color: #6B7280;

        }

                .nav-links {
                        display: flex;
                        flex-direction: column;
                        gap: 6px;

        }

                .nav-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px 16px;
                        border-radius: 8px;
                        text-decoration: none;
                        color: #4B5563;
                        font-weight: 500;
                        transition: all .2s;

        }

                    .nav-item:hover {
                            background: #F9FAFB;
                            color: #111827;

        }

                    .nav-item.active {
                            background: #D91016;
                            color: #fff;
                            box-shadow: 0 4px 10px rgba(217,16,22,.3);

        }


        /* ========== MAIN CONTENT ========== */
                .main-content {
                        margin-left: 260px;
                        width: calc(100% - 260px);
                        display: flex;
                        flex-direction: column;
                        background: #F3F4F6;
                        transition: all .3s ease;

        }

                    .main-content.full {
                            margin-left: 0;
                            width: 100%;

        }


        /* ========== TOP BAR ========== */
                .top-bar {
                        position: sticky;
                        top: 0;
                        z-index: 50;
                        background: #fff;
                        border-bottom: 1px solid #E5E7EB;
                        padding: 1rem 2rem;
                        display: flex;
                        justify-content: space-between; /* Esto empuja los elementos a los extremos */
                        align-items: center;

        }

                .top-bar-left {
                        display: flex;
                        align-items: center;
                        gap: 12px;

        }

                    .top-bar-left h4 {
                            margin: 0;
                            font-weight: 700;
                            font-size: 1.1rem;

        }

                    .top-bar-left small {
                            color: #6B7280;

        }


        /* PARTE DERECHA DE LA BARRA */
                .top-bar-right {
                        display: flex;
                        align-items: center;
                        gap: 14px;

        }

                .icon-btn {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        background: #F3F4F6;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        border: none;
                        color: #4B5563;

        }

                    .icon-btn:hover {
                            background: #E5E7EB;

        }

                .user-avatar {
                        width: 36px;
                        height: 36px;
                        background: #D91016;
                        color: #fff;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 600;
                        text-transform: uppercase;

        }

        .main-container {
            padding: .5rem 2rem 2rem 2rem;
            flex: 1;
        }


                footer {
                        padding: 1.5rem;
                        text-align: center;
                        font-size: .8rem;
                        color: #9CA3AF;

        }

                @@media (max-width: 900px) {
                        .sidebar

        {
                            transform: translateX(-100%);

        }

                    .main-content {
                            margin-left: 0;
                            width: 100%;

        }


        }

    </style>
</head>

<body>
    <div class="dashboard-wrapper">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-box">
                    <i data-lucide="graduation-cap"></i>
                </div>
                <div class="logo-text">
                    <h5>Sistema de Maestrías<br />UTN</h5>
                    <small>Gestión Académica</small>
                </div>
            </div>

            <nav class="nav-links">
                <a asp-controller="Home" asp-action="Index"
                             class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Home" ? "active" : "")">
                    <i data-lucide="layout-grid"></i> Dashboard
                </a>

                <a asp-controller="Aspirantes" asp-action="ListAspirantes"
                             class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Aspirantes" ? "active" : "")">
                    <i data-lucide="users"></i> Aspirantes
                </a>
                                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="CamposConocimientos" asp-action="ListCamposConocimientos"
                    class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "CamposConocimientos" ? "active" : "")">
                        <i data-lucide="book-open"></i> Campos Conoc.
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Programas" asp-action="ListProgramas"
                    class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Programas" ? "active" : "")">
                        <i data-lucide="graduation-cap"></i> Programas
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Accounts" asp-action="ListUsuarios"
                    class="nav-item @(ViewContext.RouteData.Values["Action"]?.ToString() == "Accounts" ? "active" : "")">
                        <i data-lucide="shield"></i> Personal Administrativo
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Niveles" asp-action="ListNiveles"
                    class="nav-item @(ViewContext.RouteData.Values["Action"]?.ToString() == "Niveles" ? "active" : "")">
                        <i data-lucide="shield"></i> Niveles
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Roles" asp-action="ListRoles"
                    class="nav-item @(ViewContext.RouteData.Values["Action"]?.ToString() == "Roles" ? "active" : "")">
                        <i data-lucide="shield"></i> Roles
                    </a>
                }
            </nav>
        </aside>

        <main class="main-content" id="mainContent">

            <header class="top-bar">
                <div class="top-bar-left">
                    <div class="icon-btn" id="btnToggleSidebar">
                        <span id="iconContainer"><i data-lucide="x"></i></span>
                    </div>
                    <div>
                        <h4>Panel Administrativo</h4>
                        <small>Gestión de Aspirantes a Programas de Posgrado</small>
                    </div>
                </div>

                <div class="top-bar-right">

                    <!-- NOTIFICACIONES -->
                    <div class="dropdown position-relative">

                        <div id="btnNotificaciones"
                             class="icon-btn dropdown-toggle"
                             data-bs-toggle="dropdown"
                             style="cursor:pointer;">
                            <i data-lucide="bell"></i>
                        </div>

                        @if (notificacionesHoyLayout > 0)

                        {
                            <span id="badgeNotificaciones"
                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                @ViewBag.NotificacionesNoLeidas
                            </span>
                        }

                        <ul class="dropdown-menu dropdown-menu-end shadow p-2"
                            style="width:320px; border-radius:12px;">

                            <li class="dropdown-header fw-bold">
                                Nuevos Aspirantes
                            </li>
                            <li><hr class="dropdown-divider" /></li>

                            @if (notificacionesLayout.Count > 0)
                            {
                                foreach (var n in notificacionesLayout)
                                {
                                    <li class="dropdown-item small py-2">

                                        <div class="notificacion-texto"
                                             title="@n.nombreasp se registró en @n.programainteres">
                                            <strong>@n.nombreasp</strong> se registró en
                                            <strong>@n.programainteres</strong>
                                        </div>


                                        <small class="text-muted">
                                            @n.fecharegistro.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </li>

                                    <li><hr class="dropdown-divider" /></li>
                                }

                                <li>
                                    <a asp-controller="Aspirantes"
                                       asp-action="ListAspirantes"
                                       class="dropdown-item text-center fw-semibold text-danger">
                                        Ver todos
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="dropdown-item text-muted">
                                    No hay notificaciones
                                </li>
                            }
                        </ul>
                    </div>


                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="user-avatar">
                            @User.Identity.Name.Substring(0, 1)
                        </div>

                        <a asp-controller="Login" asp-action="Logout" class="btn btn-outline-secondary btn-sm d-none d-md-inline-block">
                            Cerrar Sesión
                        </a>
                    }
                    else
                    {
                        <div class="user-avatar">AD</div>
                        <a href="#" class="btn btn-outline-secondary btn-sm">Cerrar Sesión</a>
                    }
                </div>
            </header>

            <div class="px-4 pt-3">
                @if (IsSectionDefined("Breadcrumb"))
                {
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            @RenderSection("Breadcrumb", required: false)
                        </ol>
                    </nav>
                }
            </div>

            <div class="main-container">
                @RenderBody()
            </div>

            <footer>
                2026 - Universidad Técnica del Norte
            </footer>
        </main>
    </div>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        lucide.createIcons();

        const btn = document.getElementById("btnToggleSidebar");
        const sidebar = document.getElementById("sidebar");
        const main = document.getElementById("mainContent");
        const iconContainer = document.getElementById("iconContainer");

        btn.addEventListener("click", () => {
            sidebar.classList.toggle("hidden");
            main.classList.toggle("full");

            const isHidden = sidebar.classList.contains("hidden");
            const iconName = isHidden ? "menu" : "x";

            // Cambiamos el icono dinámicamente
            iconContainer.innerHTML = `<i data-lucide="${iconName}"></i>`;
            lucide.createIcons();
        });

            const btnNoti = document.getElementById("btnNotificaciones");
        const badgeNoti = document.getElementById("badgeNotificaciones");

        if (btnNoti && badgeNoti) {
            btnNoti.addEventListener("click", () => {
                badgeNoti.style.display = "none";
            });
        }
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>