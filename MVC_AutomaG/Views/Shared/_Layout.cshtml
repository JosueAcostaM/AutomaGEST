@using Modelos_AutomaG
@using API_Consumer

@{
    var aspirantesLayout = CRUD<Aspirantes>.GetAll();

    var notificacionesLayout = aspirantesLayout
        .OrderByDescending(a => a.fecharegistro)
        .Take(5)
        .ToList();

    var notificacionesHoyLayout = aspirantesLayout
        .Count(a => a.fecharegistro.Date == DateTime.Today);
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Sistema de Maestrías</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/Layout.css" asp-append-version="true" />
    <script src="https://unpkg.com/lucide@latest"></script>

</head>

<body>
    <div class="dashboard-wrapper">

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-box">
                    <i data-lucide="graduation-cap"></i>
                </div>
                <div class="logo-text">
                    <h5>Sistema de Maestrías<br />UTN</h5>
                    <small>Gestión Académica</small>
                </div>
            </div>

            <nav class="nav-links">
                <a asp-controller="Home" asp-action="Index"
                             class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Home" ? "active" : "")">
                    <i data-lucide="layout-grid"></i> Dashboard
                </a>

                <a asp-controller="Aspirantes" asp-action="ListAspirantes"
                             class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Aspirantes" ? "active" : "")">
                    <i data-lucide="users"></i> Aspirantes
                </a>
                                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="CamposConocimientos" asp-action="ListCamposConocimientos"
                    class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "CamposConocimientos" ? "active" : "")">
                        <i data-lucide="book-open"></i> Campos Conoc.
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Programas" asp-action="ListProgramas"
                    class="nav-item @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Programas" ? "active" : "")">
                        <i data-lucide="graduation-cap"></i> Programas
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Accounts" asp-action="ListUsuarios"
                    class="nav-item @(ViewContext.RouteData.Values["Action"]?.ToString() == "Accounts" ? "active" : "")">
                        <i data-lucide="shield"></i> Personal Administrativo
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Niveles" asp-action="ListNiveles"
                    class="nav-item @(ViewContext.RouteData.Values["Action"]?.ToString() == "Niveles" ? "active" : "")">
                        <i data-lucide="shield"></i> Niveles
                    </a>
                }
                @if (User.IsInRole("Super Administrador"))
                {
                    <a asp-controller="Roles" asp-action="ListRoles"
                    class="nav-item @(ViewContext.RouteData.Values["Action"]?.ToString() == "Roles" ? "active" : "")">
                        <i data-lucide="shield"></i> Roles
                    </a>
                }
            </nav>
        </aside>

        <main class="main-content" id="mainContent">

            <header class="top-bar">
                <div class="top-bar-left">
                    <div class="icon-btn" id="btnToggleSidebar">
                        <span id="iconContainer"><i data-lucide="x"></i></span>
                    </div>
                    <div>
                        <h4>Panel Administrativo</h4>
                        <small>Gestión de Aspirantes a Programas de Posgrado</small>
                    </div>
                </div>

                <div class="top-bar-right">

                    <!-- NOTIFICACIONES -->
                    <div class="dropdown position-relative">

                        <div id="btnNotificaciones"
                             class="icon-btn dropdown-toggle"
                             data-bs-toggle="dropdown"
                             style="cursor:pointer;">
                            <i data-lucide="bell"></i>
                        </div>

                        @if (notificacionesHoyLayout > 0)

                        {
                            <span id="badgeNotificaciones"
                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                @ViewBag.NotificacionesNoLeidas
                            </span>
                        }

                        <ul class="dropdown-menu dropdown-menu-end shadow p-2"
                            style="width:320px; border-radius:12px;">

                            <li class="dropdown-header fw-bold">
                                Nuevos Aspirantes
                            </li>
                            <li><hr class="dropdown-divider" /></li>

                            @if (notificacionesLayout.Count > 0)
                            {
                                foreach (var n in notificacionesLayout)
                                {
                                    <li class="dropdown-item small py-2">

                                        <div class="notificacion-texto"
                                             title="@n.nombreasp se registró en @n.programainteres">
                                            <strong>@n.nombreasp</strong> se registró en
                                            <strong>@n.programainteres</strong>
                                        </div>


                                        <small class="text-muted">
                                            @n.fecharegistro.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </li>

                                    <li><hr class="dropdown-divider" /></li>
                                }

                                <li>
                                    <a asp-controller="Aspirantes"
                                       asp-action="ListAspirantes"
                                       class="dropdown-item text-center fw-semibold text-danger">
                                        Ver todos
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="dropdown-item text-muted">
                                    No hay notificaciones
                                </li>
                            }
                        </ul>
                    </div>


                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="user-avatar">
                            @User.Identity.Name.Substring(0, 1)
                        </div>

                        <a asp-controller="Login" asp-action="Logout" class="btn btn-outline-secondary btn-sm d-none d-md-inline-block">
                            Cerrar Sesión
                        </a>
                    }
                    else
                    {
                        <div class="user-avatar">AD</div>
                        <a href="#" class="btn btn-outline-secondary btn-sm">Cerrar Sesión</a>
                    }
                </div>
            </header>

            <div class="px-4 pt-3">
                @if (IsSectionDefined("Breadcrumb"))
                {
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            @RenderSection("Breadcrumb", required: false)
                        </ol>
                    </nav>
                }
            </div>

            <div class="main-container">
                @RenderBody()
            </div>

            <footer>
                2026 - Universidad Técnica del Norte
            </footer>
        </main>
    </div>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        lucide.createIcons();

        const btn = document.getElementById("btnToggleSidebar");
        const sidebar = document.getElementById("sidebar");
        const main = document.getElementById("mainContent");
        const iconContainer = document.getElementById("iconContainer");

        btn.addEventListener("click", () => {
            sidebar.classList.toggle("hidden");
            main.classList.toggle("full");

            const isHidden = sidebar.classList.contains("hidden");
            const iconName = isHidden ? "menu" : "x";

            // Cambiamos el icono dinámicamente
            iconContainer.innerHTML = `<i data-lucide="${iconName}"></i>`;
            lucide.createIcons();
        });

            const btnNoti = document.getElementById("btnNotificaciones");
        const badgeNoti = document.getElementById("badgeNotificaciones");

        if (btnNoti && badgeNoti) {
            btnNoti.addEventListener("click", () => {
                badgeNoti.style.display = "none";
            });
        }
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>