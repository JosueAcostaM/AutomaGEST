@model IEnumerable<Modelos_AutomaG.Programas>

@{
    ViewData["Title"] = "Programas de Maestría";
    var niveles = ViewBag.Nivel as IEnumerable<Modelos_AutomaG.Niveles>;
}

@if (User.IsInRole("Super Administrador"))
{
    <link rel="stylesheet" href="~/css/programas-lista.css" asp-append-version="true" />

    @section Breadcrumb {
        <li class="breadcrumb-item">
            <a asp-controller="Home" asp-action="Index">Inicio</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Programas
        </li>
    }

    <div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">

        <div class="page-heading-row">
            <div>
                <h1 class="page-title">Programas de Postgrado</h1>
                <div class="niveles-grid" style="margin-top: 1rem;">
                    <button type="button" class="nivel-btn activo" data-nivel="TODOS">
                        Todos
                    </button>

                    @if (niveles != null)
                    {
                        foreach (var n in niveles)
                        {
                            <button type="button" class="nivel-btn" data-nivel="@n.idniv">
                                @n.nombreniv
                            </button>
                        }
                    }
                </div>
                <p class="page-subtitle">Gestiona los programas disponibles</p>
            </div>

            <a href="/Programas/Create" class="btn-add-program">
                <i data-lucide="plus" style="width: 18px;"></i> Nuevo Programa
            </a>
        </div>

        <div class="table-card">
            <div class="card-header-bar">
                <h3 class="card-title">Programas Activos y Disponibles</h3>
            </div>

            <div style="overflow-x: auto;">
                <table class="prog-table" id="tablaProgramas">
                    <tbody id="cuerpoProgramas">
                        @if (Model != null)
                        {
                            @foreach (var item in Model)
                            {
                                <tr data-id-row="@item.idpro" data-nivel="@item.idniv">
                                    <td width="60%" class="prog-name">
                                        @item.nombrepro
                                    </td>

                                    <td width="40%">
                                        <div class="d-flex align-items-center justify-content-end gap-4">

                                            <div class="switch-wrapper">
                                                <span class="estado-texto @(item.estadopro == "activo" ? "estado-activo" : "estado-inactivo")"
                                                      id="texto_@item.idpro">
                                                    @item.estadopro
                                                </span>

                                                <div class="form-check form-switch m-0">
                                                    <input class="form-check-input estado-switch"
                                                           type="checkbox"
                                                           style="cursor: pointer; width: 40px; height: 20px;"
                                                           data-id="@item.idpro"
                                                           @(item.estadopro == "activo" ? "checked" : "")>
                                                </div>
                                            </div>

                                            <div style="padding:1rem; vertical-align:middle; text-align:right;">
                                                <a asp-action="DetailsProgramas" asp-route-id="@item.idpro"
                                                   style="color:#D91016; border:1px solid #E5E7EB; padding:5px 10px; border-radius:4px; text-decoration:none; font-size:0.85rem; font-weight:600;">
                                                    Ver Detalles
                                                </a>
                                            </div>

                                            <div style="width: 1px; height: 24px; background: #E5E7EB;"></div>

                                            <button type="button"
                                                    class="btn-delete-ghost"
                                                    onclick="eliminarPrograma('@item.idpro')"
                                                    title="Eliminar Programa">
                                                <i data-lucide="trash-2" style="width: 18px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                lucide.createIcons();

                // Función para inicializar los switches
                function initSwitches() {
                    document.querySelectorAll('.estado-switch').forEach(sw => {
                        if(sw.getAttribute('data-init') === 'true') return;
                        sw.setAttribute('data-init', 'true');

                        sw.addEventListener('change', function () {
                            const id = this.dataset.id;
                            const textoLabel = document.getElementById('texto_' + id);

                            const nuevoEstadoVisual = this.checked ? "activo" : "inactivo";
                            actualizarTextoEstado(textoLabel, nuevoEstadoVisual);

                            fetch(`https://automagestapi-a6fsfueugkbrc0ez.canadacentral-01.azurewebsites.net/api/Programas/${id}/estado`, {
                                method: 'PATCH'
                            })
                            .then(r => {
                                if (!r.ok) throw new Error();
                                return r.json();
                            })
                            .then(data => {
                                actualizarTextoEstado(textoLabel, data.nuevoEstado);
                                this.checked = (data.nuevoEstado.toLowerCase() === 'activo');
                            })
                            .catch(() => {
                                this.checked = !this.checked;
                                const estadoRevertido = this.checked ? "activo" : "inactivo";
                                actualizarTextoEstado(textoLabel, estadoRevertido);
                                alert('Error de conexión al cambiar estado');
                            });
                        });
                    });
                }

                function actualizarTextoEstado(elemento, estado) {
                    elemento.textContent = estado;
                    if(estado.toLowerCase() === 'activo') {
                        elemento.classList.remove('estado-inactivo');
                        elemento.classList.add('estado-activo');
                    } else {
                        elemento.classList.remove('estado-activo');
                        elemento.classList.add('estado-inactivo');
                    }
                }

                initSwitches();

                window.eliminarPrograma = function(id) {
                    if(!confirm('¿Seguro que quieres eliminar este programa?')) return;

                    fetch(`https://automagestapi-a6fsfueugkbrc0ez.canadacentral-01.azurewebsites.net/api/Programas/${id}`, { method: 'DELETE' })
                        .then(r => {
                            if (!r.ok) throw new Error('Error al eliminar');
                            location.reload();
                        })
                        .catch(err => {
                            console.error(err);
                            alert('No se pudo eliminar el programa');
                        });
                };

                // Lógica de filtros por nivel
                function filtrarPorNivel(idniv) {
                    document.querySelectorAll('#cuerpoProgramas tr').forEach(tr => {
                        const nivelRow = tr.getAttribute('data-nivel');
                        tr.style.display = (idniv === 'TODOS' || nivelRow === idniv) ? '' : 'none';
                    });
                }

                document.querySelectorAll('.nivel-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        document.querySelectorAll('.nivel-btn').forEach(b => b.classList.remove('activo'));
                        this.classList.add('activo');
                        filtrarPorNivel(this.dataset.nivel);
                    });
                });
            });
        </script>
    }
}